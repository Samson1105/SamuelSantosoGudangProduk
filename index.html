<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Transaksi Penjualan</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      background-color: #0d6efd;
    }
    h1 {
      color: #ffffff;
      font-weight: bold;
    }
    .card {
      border: 2px solid #000;
      background-color: #ffffff;
      border-radius: 10px;
      box-shadow: 0px 4px 8px rgba(0,0,0,0.2);
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
    }
    .btn-success {
      background-color: #198754;
      border-color: #198754;
    }
    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
    }
    .table thead {
      background-color: #1c1c1c;
      color: #fff;
    }
    .stock-low {
      color: red;
      font-weight: bold;
    }
    .stock-ok {
      color: green;
      font-weight: bold;
    }
    .nama-user {
      font-weight: bold;
      color: #ffffff;
    }
  </style>
</head>

<body>
  <div class="container py-4">
    <h1 class="mb-4 text-center">üí∞ Transaksi Penjualan</h1>

    <div class="card p-3 mb-4">
      <div class="row g-2 align-items-center">
        <div class="col-md-4">
          <select id="produk" class="form-select" onchange="tampilHarga()">
            <option value="">Pilih Produk</option>
          </select>
        </div>
        <div class="col-md-2">
          <input type="number" id="jumlah" class="form-control" placeholder="Jumlah">
        </div>
        <div class="col-md-2">
          <input type="text" id="harga" class="form-control" placeholder="Harga" readonly>
        </div>
        <div class="col-auto">
          <button id="tambah-btn" class="btn btn-primary">Tambah</button>
        </div>
      </div>
    </div>

    <div class="card p-3 mb-4">
      <h5>üì¶ Stok Produk</h5>
      <table class="table table-bordered bg-white">
        <thead>
          <tr>
            <th>Produk</th>
            <th>Harga</th>
            <th>Stok</th>
          </tr>
        </thead>
        <tbody id="stok-produk"></tbody>
      </table>
    </div>

    <div class="card p-3">
      <h5>üõí Keranjang</h5>
      <table class="table table-bordered bg-white">
        <thead>
          <tr>
            <th>Produk</th>
            <th>Jumlah</th>
            <th>Harga</th>
            <th>Subtotal</th>
            <th>Aksi</th>
          </tr>
        </thead>
        <tbody id="keranjang"></tbody>
        <tfoot>
          <tr>
            <td colspan="3" class="text-end"><strong>Total</strong></td>
            <td colspan="2"><strong>Rp <span id="total">0</span></strong></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="d-flex align-items-center mt-3 gap-3">
      <button class="btn btn-success" id="simpan-btn">üíæ Simpan Transaksi</button>
      <button class="btn btn-danger" id="erase-btn">üóëÔ∏è Erase Transaksi</button>
      <span class="nama-user">Samuel Santoso Setiawan</span>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://hpodaqivkvsouvqfklsw.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imhwb2RhcWl2a3Zzb3V2cWZrbHN3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0NjQ3NjcsImV4cCI6MjA3MzA0MDc2N30.3TNcN7PGaOsf8ZVOsH2hMFkHvWRp1rqbt1EmHpu3rw0"; 
    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    let produkList = [];
    let keranjang = [];

    async function loadProduk() {
      const { data, error } = await db.from("produk").select("*").order("nama", { ascending: true });
      if (error) return Swal.fire("Error", error.message, "error");
      produkList = data;

      let select = document.getElementById("produk");
      select.innerHTML = `<option value="">Pilih Produk</option>`;
      data.forEach(p => {
        let opt = document.createElement("option");
        opt.value = p.id;
        opt.setAttribute("data-harga", p.harga);
        opt.textContent = p.nama;
        select.appendChild(opt);
      });

      renderStokProduk();
    }

    function tampilHarga() {
      let produk = document.getElementById("produk");
      let harga = produk.options[produk.selectedIndex]?.getAttribute("data-harga") || "";
      document.getElementById("harga").value = harga;
    }

    function tambahItem() {
      let id = document.getElementById("produk").value;
      let jumlah = parseInt(document.getElementById("jumlah").value);
      if (!id || !jumlah) return Swal.fire("Oops!", "Pilih produk dan isi jumlah", "warning");

      let produk = produkList.find(p => p.id == id);
      if (jumlah > produk.stok) return Swal.fire("Stok Tidak Cukup", `Stok ${produk.nama} hanya ${produk.stok}`, "error");

      let existing = keranjang.find(i => i.id == id);
      if (existing) {
        if (existing.jumlah + jumlah > produk.stok) {
          return Swal.fire("Stok Tidak Cukup", `Stok ${produk.nama} hanya ${produk.stok}`, "error");
        }
        existing.jumlah += jumlah;
      } else {
        keranjang.push({ id, jumlah });
      }
      renderKeranjang();
      document.getElementById("jumlah").value = "";
    }

    function hapusItem(index) {
      keranjang.splice(index, 1);
      renderKeranjang();
    }

    function renderKeranjang() {
      let tbody = document.getElementById("keranjang");
      tbody.innerHTML = "";
      let total = 0;

      keranjang.forEach((item, i) => {
        let p = produkList.find(prod => prod.id == item.id);
        let subtotal = p.harga * item.jumlah;
        total += subtotal;
        tbody.innerHTML += `
          <tr>
            <td>${p.nama}</td>
            <td>${item.jumlah}</td>
            <td>Rp ${p.harga.toLocaleString()}</td>
            <td>Rp ${subtotal.toLocaleString()}</td>
            <td><button class="btn btn-danger btn-sm" onclick="hapusItem(${i})">Hapus</button></td>
          </tr>
        `;
      });

      document.getElementById("total").textContent = total.toLocaleString();
    }

    function renderStokProduk() {
      let tbody = document.getElementById("stok-produk");
      tbody.innerHTML = "";
      produkList.forEach(p => {
        let stockClass = p.stok < 5 ? "stock-low" : "stock-ok";
        tbody.innerHTML += `
          <tr>
            <td>${p.nama}</td>
            <td>Rp ${p.harga.toLocaleString()}</td>
            <td class="${stockClass}">${p.stok}</td>
          </tr>
        `;
      });
    }

    async function simpanTransaksi() {
      if (keranjang.length === 0) return Swal.fire("Oops!", "Keranjang kosong", "warning");

      let total = keranjang.reduce((sum, item) => {
        let p = produkList.find(prod => prod.id == item.id);
        return sum + (p.harga * item.jumlah);
      }, 0);

      const { data: penjualan, error } = await db.from("penjualan").insert([{ 
        tanggal: new Date().toISOString(), total 
      }]).select().single();

      if (error) return Swal.fire("Error", error.message, "error");

      let details = keranjang.map(item => {
        let p = produkList.find(prod => prod.id == item.id);
        return { id_penjualan: penjualan.id, id_produk: p.id, jumlah: item.jumlah, harga: p.harga, subtotal: p.harga * item.jumlah };
      });
      await db.from("penjualan_detail").insert(details);

      for (let item of keranjang) {
        let p = produkList.find(prod => prod.id == item.id);
        await db.from("produk").update({ stok: p.stok - item.jumlah }).eq("id", p.id);
      }

      Swal.fire("Sukses", "Transaksi berhasil disimpan", "success");
      keranjang = [];
      await loadProduk();
      renderKeranjang();
    }

    function eraseTransaksi() {
      keranjang = [];
      renderKeranjang();
      Swal.fire("Dihapus", "Keranjang sudah dikosongkan", "info");
    }

    document.getElementById("tambah-btn").addEventListener("click", tambahItem);
    document.getElementById("simpan-btn").addEventListener("click", simpanTransaksi);
    document.getElementById("erase-btn").addEventListener("click", eraseTransaksi);

    loadProduk();
  </script>
</body>
</html>
